# Kubernetes

## What is K8s?

* Container Orchestration tool
* Developed initially by Google

## Why K8s?

* Trend from monolith to micro services gave rise to increased use
  containerisation technology.
* This resulted in application that now comprise of 100s or 1000s of
  running containers.
* Making managing application through self-made scripts and tools
  difficult.
* Hence, container orchestration tool was born.

## Features

* Self-healing or disaster recovery
* High availability
* Scalability

## Basic Architecture

* One or more master nodes/control plane
* Many worker nodes

## Work Node

* Container runtime
* Kubelet - Process which allows nodes to communicate with each other
* Kube Proxy

## Master Node

* API Server - entry point to K8s cluster
* Controller Manager - keeps track of whats happening in the cluster
* Scheduler - decides and ensures pods placement
* `etcd` - Kubernetes backing store(key value store)

## Virtual Network

* Creates one unified machine

## Node

* Any machine part of the cluster

## Pod

* Smallest unit in K8s
* Abstraction over container
* Usually contain only one container
* Each pod gets its own IP Address
* Pods can communicate with one another using that IP Address
* Pods are ephemeral
* When a pod dies, it may be possible that the new pod is assigned a new
  IP address and hence the `service` component comes into picture.

## Service

* Permanent IP address
* Life cycle of pod and service not connected
* Internal and External service

## ConfigMap

* For storing non-confidential data only
* Example,
    * `ENV` variables
    * Configuration Parameters

## Secrets

* For storing confidential/secret data,
* Secrets are stored in `base64` encoding
* Meant to be encrypted by 3rd party tools
* Example,
    * Username
    * Password
    * CLIENT_ID
    * CLIENT_SECRET

## Volumes

* Used for persisting Databases
* K8s doesn't manage persistence for you
* Consider volume as an external hard drive plugged into your computer

## Deployment

* Stateless
* Blueprint
* Layer of abstraction over pods
* In practice, you mostly work with `deployment` and not with `pods`
  directly.
* Shouldn't be used for deploying databases as DB is stateful

## Stateful Set

* Like deployment but used for stateful apps like databases
* More difficult than `deployment`. Due to this, it is often a common
  practice to host DB outside K8s cluster.

## Configuration file

* `apiVersion`
* `kind` (deployment/service)
* `metadata`
* `spec` (specification)
    * `replicas`
    * `selector`
    * `template`
* `status`

> `spec` will be specific to the `kind` of component

### Status

* Automatically generated by K8s
* Checks whether the desired state = actual state
* If not, then K8s will try to fix it.
* Basis of the self-healing feature of K8s

### Where does K8s get status data?

* From `etcd`
* `etcd` holds the current status of all K8s component

## Minikube

* `minikube start --driver [docker|kvm2|virtualbox]`
* `minikube status`
* `minikube stop`
* `minikube delete`
* `minikube ip`
* `minikube ssh`
* `minkube service list`

## Kubectl

* Client for interacting with API Server
* `kubectl create` (rarely used)
* `kubectl get [nodes|pods|configmap|secret|replicasets]`
* `kubectl logs`
* `kubectl describe [source] [resource]`
* `-o wide`
* `kubectl edit`
* `kubectl exec -it nginx-depl-5ddc44dd46-8p668 -- /bin/bash`
* `kubectl delete deployments.apps nginx-depl`
* `kubectl delete -f filename.yaml`

## Namespaces

* A virtual cluster within the K8s cluster
* `kubectl get namespace`
* `kubectl create namespace newnamespace`
* Used to groups logically related components
* Can't access most resources from another namespace
* Can share `service`

```yaml
db_url: mysql-service.database
```

* Some components like volumes live globally in a cluster and cannot be
  isolated into namespaces.

`kubectl api-resources --namespaced=false`

* Example,

```yaml
kind: ConfigMap
apiVersion: v1
metadata:
  name: configmap
  # namespace: default
  namespace: my-namespace
data:
  key: value
```

## Changing active namespace - `kubens`

* `kubens` is a 3rd party tool which allows you to change your default
namespace, eliminating the need of typing `-n mynamespace` every time.
* Part of `kubectx` package

## Ingress

* When an application is exposed to the outside world, the request first
  goes to the ingress and then to the internal service.
* `minikube addons enable ingress`
* `kubectl get pods -n ingress-nginx`
* `kubectl create secret tls example-com-tls --cert=tls.crt --key=tls.key`
* `curl --cacert tls.crt https://example.com`

## Creating a self-signed certificate

```bash
openssl req -x509 \
    -newkey rsa:4096 -sha256 -nodes \
    -keyout tls.key -out tls.crt \
    -subj "/CN=example.com" \
    -days 365
```
